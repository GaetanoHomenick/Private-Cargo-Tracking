<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Cargo Tracking System</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöö</text></svg>">
    <script>
        // Global loading state
        window.librariesLoaded = {
            ethers: false,
            fhevm: false,
            attempts: 0
        };

        // Enhanced script loader with multiple fallbacks
        function loadScript(sources, callback, libraryName) {
            let currentIndex = 0;

            function tryLoad() {
                if (currentIndex >= sources.length) {
                    console.error(`Failed to load ${libraryName} from all sources`);
                    callback(new Error(`${libraryName} loading failed`));
                    return;
                }

                const script = document.createElement('script');
                script.src = sources[currentIndex];
                script.crossOrigin = 'anonymous';

                script.onload = () => {
                    console.log(`${libraryName} loaded successfully from ${sources[currentIndex]}`);
                    window.librariesLoaded[libraryName.toLowerCase()] = true;
                    callback(null);
                };

                script.onerror = () => {
                    console.warn(`Failed to load ${libraryName} from ${sources[currentIndex]}`);
                    currentIndex++;
                    setTimeout(tryLoad, 100); // Small delay before next attempt
                };

                document.head.appendChild(script);
            }

            tryLoad();
        }

        // Load ethers.js with multiple fallback sources
        const ethersSources = [
            'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js',
            'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js'
        ];

        loadScript(ethersSources, (error) => {
            if (error) {
                console.error('Failed to load Ethers.js:', error);
                document.getElementById('connectionStatus').textContent = '‚ùå Ethers.js loading failed';
            } else {
                console.log('Ethers.js loaded successfully');

                // Skip FHE loading for now - focus on basic functionality
                console.log('Skipping FHE library loading - running in basic mode');
                window.librariesLoaded.fhevm = false;

                // Set status immediately
                setTimeout(() => {
                    const statusEl = document.getElementById('connectionStatus');
                    if (statusEl && statusEl.textContent.includes('loading')) {
                        statusEl.textContent = '‚úÖ Ready (Basic mode) - Connect wallet';
                    }
                }, 100);
            }
        }, 'Ethers');
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(30, 39, 59, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(64, 224, 208, 0.3);
            text-align: center;
        }

        .header h1 {
            color: #40e0d0;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 0 0 10px rgba(64, 224, 208, 0.5);
        }

        .header p {
            color: #b0b0b0;
            font-size: 1.1em;
        }

        .wallet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .wallet-address {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 0.9em;
            word-break: break-all;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .connect-btn {
            background: linear-gradient(135deg, #40e0d0 0%, #00bfa5 100%);
            color: #1a1a2e;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(64, 224, 208, 0.4);
        }

        .connect-btn:hover {
            background: linear-gradient(135deg, #00bfa5 0%, #40e0d0 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(64, 224, 208, 0.6);
        }

        .main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .panel {
            background: rgba(30, 39, 59, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(64, 224, 208, 0.2);
        }

        .panel h2 {
            color: #40e0d0;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #40e0d0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #b0b0b0;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #2a3b52;
            border-radius: 8px;
            font-size: 1em;
            background: rgba(20, 30, 48, 0.8);
            color: #e0e0e0;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #40e0d0;
            box-shadow: 0 0 10px rgba(64, 224, 208, 0.3);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .btn:disabled {
            background: #3a4556;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.btn-success {
            background: linear-gradient(135deg, #40e0d0 0%, #00bfa5 100%);
            box-shadow: 0 4px 15px rgba(64, 224, 208, 0.3);
        }

        .btn.btn-success:hover {
            background: linear-gradient(135deg, #00bfa5 0%, #40e0d0 100%);
            box-shadow: 0 6px 20px rgba(64, 224, 208, 0.5);
        }

        .btn.btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        .btn.btn-warning:hover {
            background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.5);
        }

        .cargo-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .cargo-item {
            background: rgba(20, 30, 48, 0.8);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #40e0d0;
            transition: all 0.3s ease;
        }

        .cargo-item:hover {
            background: rgba(30, 40, 60, 0.9);
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(64, 224, 208, 0.2);
        }

        .cargo-id {
            font-weight: bold;
            color: #40e0d0;
            font-size: 1.1em;
            margin-bottom: 5px;
            text-shadow: 0 0 5px rgba(64, 224, 208, 0.3);
        }

        .cargo-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9em;
            color: #b0b0b0;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-0 { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; }
        .status-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .status-2 { background: linear-gradient(135deg, #fd79a8 0%, #e74c3c 100%); color: white; }
        .status-3 { background: linear-gradient(135deg, #40e0d0 0%, #00bfa5 100%); color: white; }

        .tracking-panel {
            grid-column: 1 / -1;
        }

        .location-item {
            background: rgba(20, 30, 48, 0.8);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 3px solid #40e0d0;
        }

        .location-time {
            font-size: 0.8em;
            color: #b0b0b0;
            margin-bottom: 5px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(20, 30, 48, 0.6);
            border-radius: 8px;
            padding: 4px;
        }

        .tab {
            flex: 1;
            padding: 10px 15px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #b0b0b0;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #27ae60;
        }

        .notification.error {
            background: #e74c3c;
        }

        .notification.info {
            background: #3498db;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #2a3b52;
            border-top: 3px solid #40e0d0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .auth-section {
            border-top: 2px solid #ddd;
            padding-top: 15px;
            margin-top: 15px;
        }

        .network-info {
            background: rgba(30, 39, 59, 0.95);
            border: 1px solid rgba(64, 224, 208, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .network-info h3 {
            color: #40e0d0;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(64, 224, 208, 0.3);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .info-row .label {
            font-weight: 500;
            color: #b0b0b0;
        }

        .info-row .value {
            color: #e0e0e0;
            font-family: monospace;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .wallet-info {
                flex-direction: column;
                align-items: stretch;
            }

            .cargo-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöö Private Cargo Tracking</h1>
            <p>Confidential Logistics Management System</p>
            <div class="wallet-info">
                <div class="wallet-address" id="walletAddress">Wallet Not Connected</div>
                <button class="connect-btn" id="connectWallet">Connect Wallet</button>
            </div>
        </div>

        <div class="network-info">
            <h3>üåê Network Information</h3>
            <div class="info-row">
                <span class="label">Network:</span>
                <span class="value">Sepolia Testnet</span>
            </div>
            <div class="info-row">
                <span class="label">Chain ID:</span>
                <span class="value">11155111</span>
            </div>
            <div class="info-row">
                <span class="label">Currency:</span>
                <span class="value">ETH</span>
            </div>
            <div class="info-row">
                <span class="label">Contract:</span>
                <span class="value">0x1846d67Dcf544B374D59F6d9a9adE4e37719D57A</span>
            </div>
            <div class="info-row">
                <span class="label">Mode:</span>
                <span class="value">Basic (FHE disabled)</span>
            </div>
            <div class="info-row">
                <span class="label">Status:</span>
                <span class="value" id="connectionStatus">Loading...</span>
            </div>
        </div>

        <div class="main-content">
            <div class="panel">
                <h2>üì¶ Create Cargo</h2>
                <div class="form-group">
                    <label for="cargoWeight">Weight (1-10000 kg)</label>
                    <input type="number" id="cargoWeight" placeholder="Enter cargo weight" min="1" max="10000">
                </div>
                <div class="form-group">
                    <label for="cargoCategory">Category</label>
                    <select id="cargoCategory">
                        <option value="1">Electronics</option>
                        <option value="2">Food</option>
                        <option value="3">Clothing</option>
                        <option value="4">Furniture</option>
                        <option value="5">Chemicals</option>
                        <option value="6">Pharmaceuticals</option>
                        <option value="7">Valuables</option>
                        <option value="8">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cargoValue">Value (0-1000 ETH)</label>
                    <input type="number" id="cargoValue" step="0.001" placeholder="Cargo value" min="0" max="1000">
                </div>
                <div class="form-group">
                    <label for="cargoPriority">Priority (1-10)</label>
                    <input type="number" id="cargoPriority" min="1" max="10" value="5">
                </div>
                <div class="form-group">
                    <label for="receiverAddress">Receiver Address (0x...)</label>
                    <input type="text" id="receiverAddress" placeholder="0x1234567890123456789012345678901234567890" maxlength="42">
                </div>
                <button class="btn" id="createCargoBtn">Create Cargo</button>
                <div id="createStatus"></div>
            </div>

            <div class="panel">
                <div class="tabs">
                    <div class="tab active" data-tab="shipped">My Shipments</div>
                    <div class="tab" data-tab="received">Received</div>
                </div>

                <div class="tab-content active" id="shipped">
                    <div class="cargo-list" id="shippedCargos">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            No shipments found
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="received">
                    <div class="cargo-list" id="receivedCargos">
                        <div style="text-align: center; padding: 20px; color: #666;">
                            No received cargos found
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel tracking-panel">
                <h2>üìç Track Cargo</h2>
                <div class="form-group">
                    <label for="trackingId">Cargo ID</label>
                    <input type="number" id="trackingId" placeholder="Enter cargo ID to track">
                </div>
                <button class="btn btn-success" id="trackCargoBtn">Track Cargo</button>

                <div id="trackingInfo" style="margin-top: 20px; display: none;">
                    <h3>Cargo Information</h3>
                    <div id="cargoInfo"></div>

                    <h3 style="margin-top: 20px;">Location History</h3>
                    <div id="locationHistory"></div>
                </div>

                <div class="auth-section">
                    <h3>üîê Authorization Management</h3>
                    <div class="form-group">
                        <label for="authCargoId">Cargo ID</label>
                        <input type="number" id="authCargoId" placeholder="Cargo ID">
                    </div>
                    <div class="form-group">
                        <label for="authAddress">Authorized Address</label>
                        <input type="text" id="authAddress" placeholder="0x...">
                    </div>
                    <div class="form-group">
                        <label>Permission Types</label>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 5px;">
                            <label style="display: flex; align-items: center; margin-bottom: 0;">
                                <input type="checkbox" id="canView" style="margin-right: 5px;">
                                View Info
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 0;">
                                <input type="checkbox" id="canTrack" style="margin-right: 5px;">
                                Track Location
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 0;">
                                <input type="checkbox" id="canUpdate" style="margin-right: 5px;">
                                Update Status
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="authExpires">Authorization Duration (days)</label>
                        <input type="number" id="authExpires" value="30" min="1" max="365">
                    </div>
                    <button class="btn btn-warning" id="grantAuthBtn">Grant Authorization</button>
                </div>
            </div>

            <div class="panel">
                <h2>üöõ Update Location</h2>
                <div class="form-group">
                    <label for="updateCargoId">Cargo ID</label>
                    <input type="number" id="updateCargoId" placeholder="Cargo ID">
                </div>
                <div class="form-group">
                    <label for="latitude">Latitude</label>
                    <input type="number" id="latitude" step="0.000001" placeholder="39.904200">
                </div>
                <div class="form-group">
                    <label for="longitude">Longitude</label>
                    <input type="number" id="longitude" step="0.000001" placeholder="116.407396">
                </div>
                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status">
                        <option value="0">Pending</option>
                        <option value="1">In Transit</option>
                        <option value="2">Arrived</option>
                        <option value="3">Delivered</option>
                    </select>
                </div>
                <button class="btn" id="updateLocationBtn">Update Location</button>

                <div style="margin-top: 20px;">
                    <button class="btn" id="getCurrentLocation" style="background: #9b59b6;">Get Current Location</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Contract configuration
        const CONTRACT_ADDRESS = "0x1846d67Dcf544B374D59F6d9a9adE4e37719D57A";
        const CONTRACT_ABI = [
            "function createCargo(uint32 _weight, uint8 _category, uint32 _value, uint8 _priority, address _receiver) external returns (uint32)",
            "function updateLocation(uint32 _cargoId, uint32 _latitude, uint32 _longitude, uint8 _status) external",
            "function grantAuthorization(uint32 _cargoId, address _authorized, bool _canView, bool _canTrack, bool _canUpdate, uint256 _expiresAt) external",
            "function getCargoInfo(uint32 _cargoId) external view returns (address shipper, address receiver, uint256 timestamp, uint256 locationCount)",
            "function getShipperCargos(address _shipper) external view returns (uint32[] memory)",
            "function getReceiverCargos(address _receiver) external view returns (uint32[] memory)",
            "function getLocationCount(uint32 _cargoId) external view returns (uint256)",
            "function checkAuthorization(uint32 _cargoId, address _user) external view returns (bool canView, bool canTrack, bool canUpdate, uint256 expiresAt, bool isExpired)",
            "event CargoCreated(uint32 indexed cargoId, address indexed shipper, address indexed receiver, uint256 timestamp)",
            "event LocationUpdated(uint32 indexed cargoId, address indexed updater, uint256 timestamp)"
        ];

        let provider;
        let signer;
        let contract;
        let userAddress;
        let fhevm;

        // Check if libraries are loaded
        function checkLibraries(requireFHE = false) {
            const ethersLoaded = typeof ethers !== 'undefined';
            const fhevmLoaded = typeof fhevmjs !== 'undefined';

            console.log('Library check:', { ethersLoaded, fhevmLoaded, requireFHE });

            if (!ethersLoaded) {
                throw new Error('Ethers.js library not loaded');
            }

            if (requireFHE && !fhevmLoaded) {
                throw new Error('FHEvm.js library not loaded');
            }

            return { ethersLoaded, fhevmLoaded };
        }

        // Wait for libraries to load (only require Ethers.js)
        function waitForLibraries(maxAttempts = 20) {
            return new Promise((resolve, reject) => {
                let attempts = 0;

                const checkInterval = setInterval(() => {
                    attempts++;
                    console.log(`Checking libraries attempt ${attempts}...`);

                    try {
                        const result = checkLibraries(false); // Don't require FHE
                        if (result.ethersLoaded) {
                            clearInterval(checkInterval);
                            console.log('Essential libraries loaded successfully');
                            resolve(result);
                        }
                    } catch (error) {
                        if (attempts >= maxAttempts) {
                            clearInterval(checkInterval);
                            reject(error);
                        }
                        // Continue waiting
                    }
                }, 500); // Check every 500ms
            });
        }

        // Initialize
        async function init() {
            try {
                updateConnectionStatus("Loading libraries...");

                // Wait for essential libraries to be loaded
                const libraryStatus = await waitForLibraries();

                console.log("Essential libraries loaded, initializing app...");
                updateConnectionStatus("‚úÖ Ready (Basic mode) - Connect wallet");

                // Show info about basic mode
                showNotification('App ready in basic mode. FHE encryption features are disabled.', 'info');

            } catch (error) {
                console.error("Failed to initialize:", error);
                updateConnectionStatus("‚ùå Library loading failed");
                showNotification('Failed to load required libraries. Please refresh the page.', 'error');
            }

            setupEventListeners();
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
            document.getElementById('createCargoBtn').addEventListener('click', createCargo);
            document.getElementById('trackCargoBtn').addEventListener('click', trackCargo);
            document.getElementById('updateLocationBtn').addEventListener('click', updateLocation);
            document.getElementById('grantAuthBtn').addEventListener('click', grantAuthorization);
            document.getElementById('getCurrentLocation').addEventListener('click', getCurrentLocation);

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
        }

        // Connect wallet
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('Please install MetaMask or another Web3 wallet');
                }

                updateConnectionStatus("Connecting wallet...");
                showLoading('connectWallet', true);

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });

                if (!accounts || accounts.length === 0) {
                    throw new Error('No accounts found. Please unlock your wallet.');
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                console.log('Wallet connected:', userAddress);

                // Check current network
                const network = await provider.getNetwork();
                console.log('Current network:', network);

                // Switch to Sepolia network
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0xaa36a7' }], // Sepolia chain ID
                    });
                    console.log('Switched to Sepolia');
                } catch (switchError) {
                    console.log('Switch error:', switchError);
                    if (switchError.code === 4902 || switchError.code === -32603) {
                        // Network not added, add it
                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0xaa36a7',
                                    chainName: 'Sepolia Test Network',
                                    nativeCurrency: {
                                        name: 'ETH',
                                        symbol: 'ETH',
                                        decimals: 18
                                    },
                                    rpcUrls: ['https://sepolia.infura.io/v3/'],
                                    blockExplorerUrls: ['https://sepolia.etherscan.io/']
                                }]
                            });
                            console.log('Added Sepolia network');
                        } catch (addError) {
                            console.error('Failed to add network:', addError);
                            throw new Error('Please manually add Sepolia network to your wallet');
                        }
                    } else {
                        throw switchError;
                    }
                }

                // Verify we're on the correct network
                const finalNetwork = await provider.getNetwork();
                if (finalNetwork.chainId !== 11155111) {
                    throw new Error('Please switch to Sepolia network (Chain ID: 11155111)');
                }

                // Initialize contract
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                console.log('Contract initialized:', CONTRACT_ADDRESS);

                // Update UI
                document.getElementById('walletAddress').textContent =
                    `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                document.getElementById('connectWallet').textContent = 'Connected ‚úì';
                document.getElementById('connectWallet').disabled = true;
                document.getElementById('connectWallet').style.background = '#27ae60';

                // Load user data
                await loadUserCargos();
                updateConnectionStatus("Connected to Sepolia ‚úì");
                showNotification('Wallet connected successfully!', 'success');

            } catch (error) {
                console.error('Failed to connect wallet:', error);
                updateConnectionStatus("‚ùå Connection failed");
                showNotification(error.message || 'Failed to connect wallet', 'error');

                // Reset button state
                document.getElementById('connectWallet').textContent = 'Connect Wallet';
                document.getElementById('connectWallet').disabled = false;
            } finally {
                showLoading('connectWallet', false);
            }
        }

        // Create cargo
        async function createCargo() {
            try {
                const weight = document.getElementById('cargoWeight').value;
                const category = document.getElementById('cargoCategory').value;
                const value = document.getElementById('cargoValue').value;
                const priority = document.getElementById('cargoPriority').value;
                const receiver = document.getElementById('receiverAddress').value;

                if (!weight || !value || !receiver) {
                    throw new Error('Please fill in all required fields');
                }

                // Trim whitespace and validate address format
                const cleanReceiver = receiver.trim();
                if (!cleanReceiver.match(/^0x[a-fA-F0-9]{40}$/)) {
                    throw new Error('Invalid receiver address format. Must be a valid Ethereum address starting with 0x');
                }

                // Validate numeric inputs
                const weightNum = parseInt(weight);
                const valueNum = parseFloat(value);
                const priorityNum = parseInt(priority);

                if (weightNum <= 0 || weightNum > 10000) {
                    throw new Error('Weight must be between 1 and 10000 kg');
                }

                if (valueNum < 0 || valueNum > 1000) {
                    throw new Error('Value must be between 0 and 1000 ETH');
                }

                if (priorityNum < 1 || priorityNum > 10) {
                    throw new Error('Priority must be between 1 and 10');
                }

                showLoading('createCargoBtn', true);

                // Convert value to wei as a string, then to uint32 range
                // For contract compatibility, we'll send value in smaller units (e.g., finney = 0.001 ETH)
                const valueInFinney = Math.floor(valueNum * 1000); // Convert to finney (1 ETH = 1000 finney)

                const tx = await contract.createCargo(
                    weightNum,
                    parseInt(category),
                    valueInFinney, // Send as finney instead of wei to avoid overflow
                    priorityNum,
                    cleanReceiver
                );

                await tx.wait();

                // Clear form
                document.getElementById('cargoWeight').value = '';
                document.getElementById('cargoValue').value = '';
                document.getElementById('receiverAddress').value = '';
                document.getElementById('cargoPriority').value = '5';

                await loadUserCargos();
                showNotification('Cargo created successfully!', 'success');
            } catch (error) {
                console.error('Failed to create cargo:', error);
                showNotification(error.message, 'error');
            } finally {
                showLoading('createCargoBtn', false);
            }
        }

        // Track cargo
        async function trackCargo() {
            try {
                const cargoId = document.getElementById('trackingId').value;
                if (!cargoId) {
                    throw new Error('Please enter a cargo ID');
                }

                showLoading('trackCargoBtn', true);

                const info = await contract.getCargoInfo(parseInt(cargoId));
                const locationCount = await contract.getLocationCount(parseInt(cargoId));

                document.getElementById('cargoInfo').innerHTML = `
                    <div class="cargo-item">
                        <div class="cargo-id">Cargo #${cargoId}</div>
                        <div class="cargo-details">
                            <div><strong>Shipper:</strong> ${info.shipper.slice(0, 10)}...</div>
                            <div><strong>Receiver:</strong> ${info.receiver.slice(0, 10)}...</div>
                            <div><strong>Created:</strong> ${new Date(info.timestamp * 1000).toLocaleString()}</div>
                            <div><strong>Locations:</strong> ${locationCount} records</div>
                        </div>
                    </div>
                `;

                document.getElementById('locationHistory').innerHTML =
                    locationCount > 0 ?
                    `<div class="location-item">${locationCount} location records (authorization required for details)</div>` :
                    '<div class="location-item">No location records found</div>';

                document.getElementById('trackingInfo').style.display = 'block';
                showNotification('Cargo tracked successfully!', 'success');
            } catch (error) {
                console.error('Failed to track cargo:', error);
                showNotification(error.message, 'error');
                document.getElementById('trackingInfo').style.display = 'none';
            } finally {
                showLoading('trackCargoBtn', false);
            }
        }

        // Update location
        async function updateLocation() {
            try {
                const cargoId = document.getElementById('updateCargoId').value;
                const lat = document.getElementById('latitude').value;
                const lng = document.getElementById('longitude').value;
                const status = document.getElementById('status').value;

                if (!cargoId || !lat || !lng) {
                    throw new Error('Please fill in all required fields');
                }

                showLoading('updateLocationBtn', true);

                // Convert coordinates to integers (multiply by 1000000 to preserve 6 decimal places)
                const latInt = Math.round(parseFloat(lat) * 1000000);
                const lngInt = Math.round(parseFloat(lng) * 1000000);

                const tx = await contract.updateLocation(
                    parseInt(cargoId),
                    latInt,
                    lngInt,
                    parseInt(status)
                );

                await tx.wait();
                showNotification('Location updated successfully!', 'success');
            } catch (error) {
                console.error('Failed to update location:', error);
                showNotification(error.message, 'error');
            } finally {
                showLoading('updateLocationBtn', false);
            }
        }

        // Grant authorization
        async function grantAuthorization() {
            try {
                const cargoId = document.getElementById('authCargoId').value;
                const authAddress = document.getElementById('authAddress').value;
                const canView = document.getElementById('canView').checked;
                const canTrack = document.getElementById('canTrack').checked;
                const canUpdate = document.getElementById('canUpdate').checked;
                const days = document.getElementById('authExpires').value;

                if (!cargoId || !authAddress) {
                    throw new Error('Please fill in cargo ID and authorized address');
                }

                if (!ethers.utils.isAddress(authAddress)) {
                    throw new Error('Invalid authorized address format');
                }

                if (!canView && !canTrack && !canUpdate) {
                    throw new Error('Please select at least one permission type');
                }

                showLoading('grantAuthBtn', true);

                const expiresAt = Math.floor(Date.now() / 1000) + (parseInt(days) * 24 * 60 * 60);

                const tx = await contract.grantAuthorization(
                    parseInt(cargoId),
                    authAddress,
                    canView,
                    canTrack,
                    canUpdate,
                    expiresAt
                );

                await tx.wait();
                showNotification('Authorization granted successfully!', 'success');
            } catch (error) {
                console.error('Failed to grant authorization:', error);
                showNotification(error.message, 'error');
            } finally {
                showLoading('grantAuthBtn', false);
            }
        }

        // Get current location
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                showNotification('Geolocation not supported by browser', 'error');
                return;
            }

            showLoading('getCurrentLocation', true);

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    document.getElementById('latitude').value = position.coords.latitude.toFixed(6);
                    document.getElementById('longitude').value = position.coords.longitude.toFixed(6);
                    showNotification('Location retrieved successfully!', 'success');
                    showLoading('getCurrentLocation', false);
                },
                (error) => {
                    showNotification('Failed to get location: ' + error.message, 'error');
                    showLoading('getCurrentLocation', false);
                }
            );
        }

        // Load user cargos
        async function loadUserCargos() {
            try {
                const [shippedIds, receivedIds] = await Promise.all([
                    contract.getShipperCargos(userAddress),
                    contract.getReceiverCargos(userAddress)
                ]);

                await Promise.all([
                    loadCargoList('shippedCargos', shippedIds, 'shipped'),
                    loadCargoList('receivedCargos', receivedIds, 'received')
                ]);
            } catch (error) {
                console.error('Failed to load user cargos:', error);
            }
        }

        // Load cargo list
        async function loadCargoList(containerId, cargoIds, type) {
            const container = document.getElementById(containerId);

            if (cargoIds.length === 0) {
                container.innerHTML = `<div style="text-align: center; padding: 20px; color: #666;">No ${type} cargos found</div>`;
                return;
            }

            let html = '';
            for (const id of cargoIds) {
                try {
                    const info = await contract.getCargoInfo(id);
                    const locationCount = await contract.getLocationCount(id);

                    html += `
                        <div class="cargo-item">
                            <div class="cargo-id">Cargo #${id}</div>
                            <div class="cargo-details">
                                <div><strong>Counterpart:</strong> ${type === 'shipped' ?
                                    info.receiver.slice(0, 10) + '...' :
                                    info.shipper.slice(0, 10) + '...'}</div>
                                <div><strong>Created:</strong> ${new Date(info.timestamp * 1000).toLocaleDateString()}</div>
                                <div><strong>Locations:</strong> ${locationCount} records</div>
                                <div><strong>Status:</strong> <span class="status-badge status-1">Active</span></div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error(`Failed to load cargo ${id}:`, error);
                }
            }

            container.innerHTML = html || `<div style="text-align: center; padding: 20px; color: #666;">No ${type} cargos found</div>`;
        }

        // Switch tab
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Show loading state
        function showLoading(buttonId, loading) {
            const button = document.getElementById(buttonId);
            if (loading) {
                button.disabled = true;
                if (buttonId === 'connectWallet') {
                    button.innerHTML = '<div class="loading"></div> Connecting...';
                } else {
                    button.innerHTML = '<div class="loading"></div> Processing...';
                }
            } else {
                // Only reset if not permanently disabled
                if (buttonId !== 'connectWallet' || !button.textContent.includes('Connected')) {
                    button.disabled = false;
                    // Restore button text
                    const buttonTexts = {
                        'connectWallet': 'Connect Wallet',
                        'createCargoBtn': 'Create Cargo',
                        'trackCargoBtn': 'Track Cargo',
                        'updateLocationBtn': 'Update Location',
                        'grantAuthBtn': 'Grant Authorization',
                        'getCurrentLocation': 'Get Current Location'
                    };
                    button.innerHTML = buttonTexts[buttonId] || 'Submit';
                }
            }
        }

        // Update connection status
        function updateConnectionStatus(status) {
            document.getElementById('connectionStatus').textContent = status;
        }

        // Handle account changes
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                // User disconnected wallet
                userAddress = null;
                provider = null;
                signer = null;
                contract = null;

                document.getElementById('walletAddress').textContent = 'Wallet Not Connected';
                document.getElementById('connectWallet').textContent = 'Connect Wallet';
                document.getElementById('connectWallet').disabled = false;
                document.getElementById('connectWallet').style.background = '#27ae60';

                updateConnectionStatus("Wallet disconnected");

                // Clear cargo lists
                document.getElementById('shippedCargos').innerHTML =
                    '<div style="text-align: center; padding: 20px; color: #666;">No shipments found</div>';
                document.getElementById('receivedCargos').innerHTML =
                    '<div style="text-align: center; padding: 20px; color: #666;">No received cargos found</div>';

                showNotification('Wallet disconnected', 'info');
            } else if (accounts[0] !== userAddress) {
                // User switched accounts
                showNotification('Account changed. Please reconnect.', 'info');

                // Reset connection
                document.getElementById('connectWallet').textContent = 'Connect Wallet';
                document.getElementById('connectWallet').disabled = false;
                document.getElementById('walletAddress').textContent = 'Wallet Not Connected';
                updateConnectionStatus("Account changed - reconnect required");
            }
        }

        // Handle network changes
        function handleChainChanged(chainId) {
            const chainIdInt = parseInt(chainId, 16);
            if (chainIdInt !== 11155111) {
                showNotification('Please switch to Sepolia network', 'error');
                updateConnectionStatus("Wrong network - switch to Sepolia");
            } else {
                updateConnectionStatus("Connected to Sepolia ‚úì");
            }
        }

        // Set up wallet event listeners
        function setupWalletListeners() {
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', handleChainChanged);
                window.ethereum.on('disconnect', () => {
                    console.log('Wallet disconnected');
                    handleAccountsChanged([]);
                });
            }
        }

        // Add a backup initialization without FHE if libraries fail
        function initWithoutFHE() {
            console.log('Initializing without FHE libraries...');
            updateConnectionStatus("‚ö†Ô∏è Limited mode - Connect wallet");
            setupEventListeners();
            showNotification('Running in limited mode. Some FHE features may not work.', 'info');
        }

        // Initialize app with delay to ensure all scripts are loaded
        window.addEventListener('load', () => {
            setTimeout(async () => {
                try {
                    await init();
                    setupWalletListeners();
                } catch (error) {
                    console.error('Full initialization failed, trying limited mode:', error);
                    initWithoutFHE();
                    setupWalletListeners();
                }
            }, 3000); // 3s delay to ensure all scripts are loaded
        });

        // Add connection status check
        function displayLoadingProgress() {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement && statusElement.textContent === 'Checking...') {
                statusElement.textContent = 'Loading libraries...';
            }
        }

        // Display initial loading message
        setTimeout(displayLoadingProgress, 1000);
    </script>
</body>
</html>